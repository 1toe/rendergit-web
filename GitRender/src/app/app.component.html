<div class="app-shell" [class.dark-theme]="isDarkTheme()" [class.sidebar-collapsed]="sidebarCollapsed()" [class.loading]="loading()">
  <nav class="top-shortcuts">
    <a routerLink="/" class="home-link">Inicio</a>
    <a routerLink="/repository" class="repo-browser-link">Repository Browser</a>
  </nav>
  <header class="topbar">
    <div class="header-left">
      <h1 class="logo">RenderGit</h1>
      <div class="nav-controls" *ngIf="result()">
        <app-button
          variant="ghost"
          size="sm"
          [disabled]="!canGoBack()"
          (onClick)="goBack()"
          ariaLabel="Ir atr√°s">
          <lucide-icon name="arrow-left" size="16"></lucide-icon>
        </app-button>
        <app-button
          variant="ghost"
          size="sm"
          [disabled]="!canGoForward()"
          (onClick)="goForward()"
          ariaLabel="Ir adelante">
          <lucide-icon name="arrow-right" size="16"></lucide-icon>
        </app-button>
      </div>
    </div>
    <div class="header-center">
      <form class="repo-form" (submit)="onSubmit()" novalidate>
        <app-input
          type="text"
          placeholder="https://github.com/usuario/repositorio"
          [(ngModel)]="repoUrl"
          name="repo"
          required
          ariaLabel="URL del repositorio">
        </app-input>
        <app-button
          type="submit"
          [disabled]="loading() || !repoUrl"
          variant="default">
          {{ loading() ? 'Procesando‚Ä¶' : 'Procesar' }}
        </app-button>
      </form>
    </div>
    <div class="header-right">
      <app-theme-toggle></app-theme-toggle>
      <app-button
        variant="ghost"
        size="sm"
        (onClick)="scrollToTop()"
        ariaLabel="Ir al inicio">
        <lucide-icon name="arrow-up" size="16"></lucide-icon>
      </app-button>
    </div>
  </header>

  <router-outlet></router-outlet>
  <div class="layout" *ngIf="!error() && !navigationService.navigationState().currentPath.startsWith('repository')">
    <aside class="sidebar" *ngIf="result() as r">
      <div class="sidebar-header">
        <button type="button" class="sidebar-toggle" (click)="toggleSidebar()" [title]="sidebarCollapsed() ? 'Expandir sidebar' : 'Colapsar sidebar'">
          <lucide-icon [name]="sidebarCollapsed() ? 'chevron-right' : 'chevron-left'" size="16"></lucide-icon>
        </button>
        <button type="button" class="sidebar-pin" (click)="toggleSidebarPin()" [class.active]="sidebarPinned()" title="Fijar sidebar">
          <lucide-icon [name]="sidebarPinned() ? 'pin' : 'pin-off'" size="16"></lucide-icon>
        </button>
      </div>

      <div class="sidebar-content">
        <app-collapsible-section persistKey="search">
          <div title>Buscar</div>
          <app-input
            type="search"
            placeholder="Buscar archivos..."
            [(ngModel)]="searchQuery"
            (ngModelChange)="onSearch($event)">
            <div input-suffix *ngIf="searchQuery">
              <app-button
                variant="ghost"
                size="sm"
                (onClick)="searchQuery.set('')"
                ariaLabel="Limpiar b√∫squeda">
                <lucide-icon name="x" size="14"></lucide-icon>
              </app-button>
            </div>
          </app-input>
        </app-collapsible-section>

        <app-collapsible-section persistKey="filter">
          <div title>Filtrar</div>
          <app-input
            type="text"
            placeholder="Filtrar archivos"
            [(ngModel)]="filter">
          </app-input>
        </app-collapsible-section>

        <app-collapsible-section persistKey="meta" [initialCollapsed]="false">
          <div title>Informaci√≥n del Repositorio</div>
          <app-card variant="elevated" padding="sm">
            <div card-content>
              <div class="repo-info">
                <div class="repo-link">
                  <strong>Repo:</strong>
                  <a [href]="'https://github.com/' + r.owner + '/' + r.repo" target="_blank">
                    {{ r.owner }}/{{ r.repo }}
                  </a>
                </div>
                <div class="repo-details">
                  <app-badge variant="secondary" size="sm">
                    Commit: {{ r.commitSha.slice(0,8) }}
                  </app-badge>
                  <app-badge variant="outline" size="sm">
                    Total: {{ r.files.length }}
                  </app-badge>
                  <app-badge variant="success" size="sm">
                    Renderizados: {{ r.rendered.length }}
                  </app-badge>
                </div>
              </div>
            </div>
          </app-card>
        </app-collapsible-section>

        <app-collapsible-section persistKey="toc" [initialCollapsed]="false">
          <div title>Contenido ({{ filteredToc().length }})</div>
          <nav>
            <ul>
              <li *ngFor="let t of filteredToc()">
                <a [href]="'#file-' + slugify(t.rel)" (click)="onFileSelect(t.rel)">{{ t.rel }}</a>
                <span class="size">{{ bytesHuman(t.size) }}</span>
              </li>
            </ul>
          </nav>
        </app-collapsible-section>

        <app-separator></app-separator>

        <app-collapsible-section persistKey="view-options">
          <div title>Opciones de Vista</div>
          <div class="view-options">
            <app-button
              variant="outline"
              size="sm"
              [class.active]="viewMode() === 'human'"
              (onClick)="switchView('human')">
              üë§ Humano
            </app-button>
            <app-button
              variant="outline"
              size="sm"
              [class.active]="viewMode() === 'llm'"
              (onClick)="switchView('llm')">
              ü§ñ LLM
            </app-button>
          </div>
        </app-collapsible-section>
      </div>
    </aside>

    <main class="content" *ngIf="result() as r">
      <section class="intro" *ngIf="!r.rendered.length && !loading()">
        <p>Ingresa una URL p√∫blica de GitHub para aplanar el repositorio en una sola p√°gina navegable y una vista CXML apta para LLMs.</p>
      </section>

      <section class="loading-state" *ngIf="loading()">
        <div class="spinner" aria-hidden="true"></div>
        <p>Procesando repositorio‚Ä¶</p>
      </section>

      <ng-container *ngIf="!loading()">
        <section *ngIf="viewMode() === 'human'" class="human-view">
          <div class="content-header">
            <h2>Explorador de Archivos</h2>
            <div class="view-controls">
              <app-button
                variant="outline"
                size="sm"
                [class.active]="viewMode() === 'human'"
                (onClick)="viewMode.set('human')">
                <lucide-icon name="user" size="14"></lucide-icon> Humano
              </app-button>
              <app-button
                variant="outline"
                size="sm"
                [class.active]="viewMode() === 'llm'"
                (onClick)="viewMode.set('llm')">
                <lucide-icon name="bot" size="14"></lucide-icon> LLM
              </app-button>
            </div>
          </div>

          <div class="content-layout">
            <aside class="file-explorer">
              <app-file-tree
                [treeData]="fileTree()"
                (fileSelected)="onFileSelect($event)"
                (directoryToggled)="onFileTreeToggle($event)">
              </app-file-tree>
            </aside>

            <main class="file-content">
              <section class="files">
                <article *ngFor="let f of visibleRendered()" class="file" [attr.id]="'file-' + slugify(f.path)">
                  <header class="file-header">
                    <h3>{{ f.path }}</h3>
                    <span class="file-size">{{ bytesHuman(f.size) }}</span>
                  </header>
                  <div class="file-body" [innerHTML]="f.isMarkdown ? (f.content | markdown) : ('```\n' + (f.content || '') + '\n```' | markdown)"></div>
                  <a class="back-top" href="#top" aria-label="Volver al inicio">
                    <lucide-icon name="arrow-up" size="16"></lucide-icon>
                  </a>
                </article>
                <ng-container *ngIf="result() as rr">
                  <div class="load-more" *ngIf="rr.rendered && visibleRendered().length < rr.rendered.length">
                    <app-button variant="outline" size="sm" (onClick)="enqueueBatch()">Cargar m√°s ({{ visibleRendered().length }}/{{ rr.rendered.length }})</app-button>
                  </div>
                </ng-container>
              </section>
            </main>
          </div>

          <section class="skips">
            <app-card variant="outlined" padding="sm">
              <div card-header>
                <h3>Archivos Omitidos</h3>
              </div>
              <div card-content>
                <app-collapsible-section *ngIf="r.skippedBinary.length" persistKey="skipped-binary" [initialCollapsed]="true">
                  <div title>
                    <app-badge variant="destructive" size="sm">{{ r.skippedBinary.length }}</app-badge>
                    Binarios
                  </div>
                  <app-card variant="elevated" padding="sm">
                    <div card-content>
                      <ul class="skipped-list">
                        <li *ngFor="let f of r.skippedBinary" class="skipped-item">
                          <span class="file-path">{{ f.path }}</span>
                          <app-badge variant="outline" size="sm">{{ bytesHuman(f.size) }}</app-badge>
                        </li>
                      </ul>
                    </div>
                  </app-card>
                </app-collapsible-section>

                <app-separator *ngIf="r.skippedBinary.length && r.skippedLarge.length"></app-separator>

                <app-collapsible-section *ngIf="r.skippedLarge.length" persistKey="skipped-large" [initialCollapsed]="true">
                  <div title>
                    <app-badge variant="warning" size="sm">{{ r.skippedLarge.length }}</app-badge>
                    Archivos Grandes
                  </div>
                  <app-card variant="elevated" padding="sm">
                    <div card-content>
                      <ul class="skipped-list">
                        <li *ngFor="let f of r.skippedLarge" class="skipped-item">
                          <span class="file-path">{{ f.path }}</span>
                          <app-badge variant="outline" size="sm">{{ bytesHuman(f.size) }}</app-badge>
                        </li>
                      </ul>
                    </div>
                  </app-card>
                </app-collapsible-section>
              </div>
            </app-card>
          </section>
        </section>
        <section *ngIf="viewMode() === 'llm'" class="llm-view">
          <h2>Vista LLM (CXML)</h2>
          <textarea readonly class="cxml" (focus)="onTextareaFocus($event)">{{ r.cxmlText }}</textarea>
          <p class="hint">Consejo: Ctrl + A luego Ctrl + C para copiar todo.</p>
        </section>
      </ng-container>
    </main>
  </div>

  <div class="error" *ngIf="error()"><strong>Error:</strong> {{ error() }}</div>
</div>
